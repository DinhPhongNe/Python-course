import sys
from PyQt6.QtCore import Qt
from PyQt6.QtGui import QIntValidator
from PyQt6.QtWidgets import QMainWindow, QApplication, QMessageBox, QLineEdit, QPushButton, QTableWidget, QTableWidgetItem, QTabWidget, QComboBox
from PyQt6 import uic
import random
import json

class Main(QMainWindow):
    def __init__(self) -> None:
        super().__init__()
        uic.loadUi("gui/menu.ui", self)
        self.phone_validator = QIntValidator()
        self.phone_validator.setBottom(0)
        self.phone_validator.setTop(999999999)
        self.HocSinh_btn.clicked.connect(self.Login_hs)
        self.GiaoVien_btn.clicked.connect(self.Login_tc)
        self.Register_btn.clicked.connect(self.regis)
        self.quit_btn.clicked.connect(self.quit)
        
        self.teacher_login = None
        self.student_login = None
        self.register = None
        self.teacher_main = None
        self.student_main = None
        self.renewpass = None
        self.btvn_upload = None

        self.msg_box = QMessageBox()
        self.msg_box.setWindowTitle("Lỗi")
        self.msg_box.setIcon(QMessageBox.Icon.Warning)
        self.msg_box.setStyleSheet("background-color: #F8F2EC; color: #356a9c")
        
    def quit(self):
        window.close()

    def Login_tc(self):
        if not self.teacher_login:
            self.teacher_login = uic.loadUi("gui/login-teacher.ui")
            self.PhoneTC = self.teacher_login.findChild(QLineEdit, "PhoneTC")
            self.PhoneTC.setValidator(self.phone_validator)
            self.PassTC = self.teacher_login.findChild(QLineEdit, "PassTC")
            self.teacher_login.GiaoVienLogin_btn.clicked.connect(self.check_login)
            self.teacher_login.goback_tc_btn.clicked.connect(self.goback_tc_Clicked)
            self.teacher_login.forgo_pass_tc.clicked.connect(self.renew)

        self.teacher_login.show()
        self.hide()

    def check_login(self):
        Phone = self.PhoneTC.text()
        password = self.PassTC.text()
        
        if not Phone:
            self.msg_box.setText("vui lòng nhập số điện thoại!")
            self.msg_box.exec()
            return
        if not password:
            self.msg_box.setText("vui lòng nhập mật khẩu!")
            self.msg_box.exec()
            return
            
        phone_number = self.PhoneTC.text()
        if len(phone_number) != 10 or not phone_number.startswith('0'):
            self.msg_box.setText("Số điện thoại không hợp lệ!")
            self.msg_box.exec()
            return
        
        if Phone == "0987654321" and password == "admin":
            self.close()
            self.GiaoVienClicked()
        else:
            self.msg_box.setText("Số điện thoại hoặc mật khẩu sai")
            self.msg_box.exec()
            
        
    def GiaoVienClicked(self):
        if not self.teacher_main:
            self.teacher_main = uic.loadUi("gui/main-tc.ui")
            self.teacher_main.logOut_btn_tc.clicked.connect(self.GiaoVienMain_Return)
            
            self.teacher_main.add_btn.clicked.connect(self.add_information)
            self.teacher_main.nhap_diem_mon_btn.clicked.connect(self.nhap_diem)
            self.teacher_main.update_btn.clicked.connect(self.update_information)
            self.teacher_main.delete_btn.clicked.connect(self.delete_information)
            self.teacher_main.search_btn.clicked.connect(self.search)
            self.teacher_main.clear_btn.clicked.connect(self.clear_information)
            self.teacher_main.btvn_upload_btn.clicked.connect(self.upload_btvn)

            
            self.table = self.teacher_main.findChild(QTabWidget, "Semester_tab")
            self.table_HK1 = self.teacher_main.findChild(QTableWidget, "student_Infor_table_HK1")
            self.table_HK2 = self.teacher_main.findChild(QTableWidget, "student_Infor_table_HK2")
            self.table_CN = self.teacher_main.findChild(QTableWidget, "student_Infor_table_CN")
            self.xem_hk1 = self.teacher_main.findChild(QComboBox, "xem_diem_mon_hk1")
            self.xem_hk2 = self.teacher_main.findChild(QComboBox, "xem_diem_mon_hk2")
            self.xem_cn = self.teacher_main.findChild(QComboBox, "xem_diem_mon_cn")
            self.search_bar = self.teacher_main.findChild(QLineEdit, "Search_bar")
            self.search_bar = self.teacher_main.findChild(QLabel, "ten_mon")

        self.teacher_main.show()
        self.teacher_login.hide()

    def search(self):
        text = self.search_bar.text().strip().lower()
        for row in range(self.table.rowCount()):
            match = False
            for column in range(self.table.columnCount()):
                item = self.table.item(row, column)
                if item and text in item.text().strip().lower():
                    match = True
                    break
            self.table.setRowHidden(row, not match)

    def nhap_diem(self):
        pass

                
    def add_information(self):
        pass

    def select_information(self):
        pass

    def update_information(self):
        pass

    def clear_information(self):
        self.msg_box.setText("Hệ thống đang thông báo đến hiệu trưởng. Đang chờ hiệu trưởng đồng ý hoặc không đồng ý.")
        self.msg_box.setStandardButtons(QMessageBox.StandardButton.Ok)
        self.msg_box.exec()

        # Random đồng ý hoặc không đồng ý
        approval = random.choice(["Đồng ý", "Không đồng ý"])

        if approval == "Đồng ý":
            confirm_box = QMessageBox()
            confirm_box.setWindowTitle("Thông báo")
            confirm_box.setIcon(QMessageBox.Icon.Information)
            confirm_box.setText("hiệu trưởng đã đồng ý. Toàn học sinh sẽ biến mất.")
            confirm_box.setStyleSheet("background-color: #F8F2EC; color: #356a9c")
            confirm_box.exec()
            self._clear_all_fields()
        else:
            confirm_box = QMessageBox()
            confirm_box.setWindowTitle("Thông báo")
            confirm_box.setIcon(QMessageBox.Icon.Information)
            confirm_box.setText("hiệu trưởng không đã đồng ý.")
            confirm_box.setStyleSheet("background-color: #F8F2EC; color: #356a9c")
            confirm_box.exec()

    def _clear_all_fields(self):
        self.stt.clear()
        self.ho.clear()
        self.ten.clear()
        self.toan.clear()
        self.van.clear()
        self.anh.clear()
        self.ly.clear()
        self.hoa.clear()
        self.sinh.clear()
        self.dia.clear()
        self.su.clear()
        self.diemTB.clear()
        self.hoc_luc.clear()
        self.hanh_kiem.clear()
        self.table.setRowCount(0)  # Clear all rows in the table


    def delete_information(self):
        self.table.removeRow(self.table.currentRow())

if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = Main()
    window.show()
    sys.exit(app.exec())


hãy chỉnh sửa code trên theo yêu cầu sau:
- tôi đã chỉnh sửa lại sử dụng QTabWidget kèm theo QTableWidget.
1. Khi khi nhấn vào add thì chỉ add các thông tin như UID, Số thứ tự, họ, tên học sinh. Search sẽ theo tên học sinh search mà ra theo row. Khi nhấn nút update, sẽ hiện ra dialog là sửa thông tin học sinh hay sửa điểm học sinh. Khi nhấn vào sửa thông tin học sinh sẽ hiện ra dialog khác cho sửa thông tin, nếu bỏ trống ô sửa thì chỉ giữ nguyên, ô nào nhập thì sửa cái đó ( ví dụ đổi UID từ 88041 thành 88042 thì đổi duy nhất cái đó, số thứ tự, họ tên giữ nguyên), còn khi nhấn sửa điểm, sẽ hiện ra nút TX1 TX2 TX3 TX4 GK 1 và HK 1 và chọn nút đó. Khi sửa nhấn xong thì sẽ thay đổi theo cột đó trong table ( ví dụ TX1 TX2 TX3 TX4 GK1 HK1 chọn TX1 đang có điểm là 8 đổi thành 9 thì table đổi thành 9). Tương tự như ở Học kì 2. Nút delete sẽ xóa theo row. nút clear thì chỉnh sửa sao cho xóa 1 table thì tất cả table khác xóa theo ( ví dụ xóa tab widget có tên là semester_1_tab thì semester_2_tab và overalltab mất theo semester_1_tab). 
2. nhấn vào nút nhập điểm sẽ hiện ra dialog nhập điểm TX 1 TX2 TX3 TX4 GK1 HK1 ( tương tự như ở học kì 2 nhưng là TX1 TX2 TX3 TX4 GK2 HK2) và khi nhập điểm thì vào ô tương ứng ( ví dụ chọn TX2 nhập điểm 8 thì table xuất hiện 8 vừa nhập ở TX2 ) LƯU Ý: table học kì 1 student_Infor_table_HK1 và table student_Infor_table_HK2 có thông tin khác nhau vì thế khi nhập điểm trước khi hỏi nhập cột TX1.... vào thì hỏi học kì mấy trước
3. Ô table ĐTBM sẽ tự động tính và thay đổi khi giáo viên nhập theo công thức sau : ((TX1+TX2+TX3+TX4) + (GK1 * 2) + (HK1 * 3))/9
4. vì lấy thông tin để cho vào table có tên là overalltab ở các ô như ( ĐTBM HK1, ĐTBM HK1, ĐTBM GK2, ĐTBM HK2, ĐTBM CN ) ô điểm trung bình môn cả năm sẽ tính theo công thức ((ĐTBM GK1 + ĐTBM HK1) + (ĐTBM GK2 + ĐTBM HK2)*2)/3
5. ở các tab có ô như xem_diem_mon_hk1, xem_diem_mon_hk2, xem_diem_mon_cn. Khi bấm vào chỉ hiện ra cột điểm học kì đang chọn môn đó
ví dụ: đang chọn học kì 1, khi nhấn chọn môn toán ở combo box thì hiện ra điểm của môn toán thôi, môn khác thì chọn môn khác ( có tổng các môn sau: Toán, Văn, Anh, Khoa học tự nhiên, Lịch sử - địa lý, tin học, công nghệ, giáo dục công dân )
6. Khi nhấn nút nhập điểm, sẽ hiện ra dialog chọn học sinh cần nhập điểm ( dựa trên học sinh đang có trên table )
7. Các thông tin học sinh được lưu theo như thế này trong file json ( file txt )

{
    "Danh_sach_hoc_sinh": [
        {
            "UID": "88041",
            "Số thứ tự": "41",
            "Họ": "Võ",
            "Tên": "Đình Phong",
            "Điểm trong năm": {
                "Học kỳ 1": {
                    "Toán": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK1": "9",
                        "HK1": "9",
                        "ĐTBM": "9.0"
                    },
                    "Văn": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK1": "9",
                        "HK1": "9",
                        "ĐTBM": "9.0"
                    },
                    "Anh": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "HK1": "9",
                        "ĐTBM": "9.0"
                    },
                    "Khoa học tự nhiên": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "HK1": "9",
                        "ĐTBM": "9.0"
                    },
                    "Lịch sử - địa lý": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "HK1": "9",
                        "ĐTBM": "9.0"
                    },
                    "Tin học": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "HK1": "9",
                        "ĐTBM": "9.0"
                    },
                    "Công nghệ": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "HK1": "9",
                        "ĐTBM": "9.0"
                    },
                    "Giáo dục công dân": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "HK1": "9",
                        "ĐTBM": "9.0"
                    }
                },
                "Học kỳ 2": {
                    "Toán": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK2": "9",
                        "HK2": "9",
                        "ĐTBM": "9.0"
                    },
                    "Văn": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK2": "9",
                        "HK2": "9",
                        "ĐTBM": "9.0"
                    },
                    "Anh": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK2": "9",
                        "HK2": "9",
                        "ĐTBM": "9.0"
                    },
                    "Khoa học tự nhiên": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK2": "9",
                        "HK2": "9",
                        "ĐTBM": "9.0"
                    },
                    "Lịch sử - địa lý": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK2": "9",
                        "HK2": "9",
                        "ĐTBM": "9.0"
                    },
                    "Tin học": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK2": "9",
                        "HK2": "9",
                        "ĐTBM": "9.0"
                    },
                    "Công nghệ": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK2": "9",
                        "HK2": "9",
                        "ĐTBM": "9.0"
                    },
                    "Giáo dục công dân": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK2": "9",
                        "HK2": "9",
                        "ĐTBM": "9.0"
                    }
                }
            }
        },
 {
            "UID": "88041",
            "Số thứ tự": "41",
            "Họ": "Võ",
            "Tên": "Đình Phong",
            "Điểm trong năm": {
                "Học kỳ 1": {
                    "Toán": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK1": "9",
                        "HK1": "9",
                        "ĐTBM": "9.0"
                    },
                    "Văn": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK1": "9",
                        "HK1": "9",
                        "ĐTBM": "9.0"
                    },
                    "Anh": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "HK1": "9",
                        "ĐTBM": "9.0"
                    },
                    "Khoa học tự nhiên": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "HK1": "9",
                        "ĐTBM": "9.0"
                    },
                    "Lịch sử - địa lý": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "HK1": "9",
                        "ĐTBM": "9.0"
                    },
                    "Tin học": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "HK1": "9",
                        "ĐTBM": "9.0"
                    },
                    "Công nghệ": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "HK1": "9",
                        "ĐTBM": "9.0"
                    },
                    "Giáo dục công dân": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "HK1": "9",
                        "ĐTBM": "9.0"
                    }
                },
                "Học kỳ 2": {
                    "Toán": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK2": "9",
                        "HK2": "9",
                        "ĐTBM": "9.0"
                    },
                    "Văn": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK2": "9",
                        "HK2": "9",
                        "ĐTBM": "9.0"
                    },
                    "Anh": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK2": "9",
                        "HK2": "9",
                        "ĐTBM": "9.0"
                    },
                    "Khoa học tự nhiên": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK2": "9",
                        "HK2": "9",
                        "ĐTBM": "9.0"
                    },
                    "Lịch sử - địa lý": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK2": "9",
                        "HK2": "9",
                        "ĐTBM": "9.0"
                    },
                    "Tin học": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK2": "9",
                        "HK2": "9",
                        "ĐTBM": "9.0"
                    },
                    "Công nghệ": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK2": "9",
                        "HK2": "9",
                        "ĐTBM": "9.0"
                    },
                    "Giáo dục công dân": {
                        "TX1": "9",
                        "TX2": "9",
                        "TX3": "9",
                        "TX4": "9",
                        "GK2": "9",
                        "HK2": "9",
                        "ĐTBM": "9.0"
                    }
                }
            }
        },
        {
            ".....": "....."
        }
    ]
}
